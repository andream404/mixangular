"use strict";angular.module("mentio",[]).directive("mentio",["mentioUtil","$document","$compile","$log","$timeout",function(s,e,a,m,u){return{restrict:"A",scope:{macros:"=mentioMacros",search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",typedTerm:"=mentioTypedTerm",altId:"=mentioId",iframeElement:"=mentioIframeElement",requireLeadingSpace:"=mentioRequireLeadingSpace",selectNotFound:"=mentioSelectNotFound",trimTerm:"=mentioTrimTerm",ngModel:"="},controller:["$scope","$timeout","$attrs",function(r,i,n){r.query=function(e,t){var n=r.triggerCharMap[e];void 0!==r.trimTerm&&!r.trimTerm||(t=t.trim()),n.showMenu(),n.search({term:t}),n.typedTerm=t},r.defaultSearch=function(t){var n=[];angular.forEach(r.items,function(e){0<=e.label.toUpperCase().indexOf(t.term.toUpperCase())&&n.push(e)}),r.localItems=n},r.bridgeSearch=function(e){(n.mentioSearch?r.search:r.defaultSearch)({term:e})},r.defaultSelect=function(e){return r.defaultTriggerChar+e.item.label},r.bridgeSelect=function(e){return(n.mentioSelect?r.select:r.defaultSelect)({item:e})},r.setTriggerText=function(e){r.syncTriggerText&&(r.typedTerm=void 0===r.trimTerm||r.trimTerm?e.trim():e)},r.context=function(){if(r.iframeElement)return{iframe:r.iframeElement}},r.replaceText=function(e,t){if(r.hideAll(),s.replaceTriggerText(r.context(),r.targetElement,r.targetElementPath,r.targetElementSelectedOffset,r.triggerCharSet,e,r.requireLeadingSpace,t),!t&&(r.setTriggerText(""),angular.element(r.targetElement).triggerHandler("change"),r.isContentEditable())){r.contentEditableMenuPasted=!0;var n=i(function(){r.contentEditableMenuPasted=!1},200);r.$on("$destroy",function(){i.cancel(n)})}},r.hideAll=function(){for(var e in r.triggerCharMap)r.triggerCharMap.hasOwnProperty(e)&&r.triggerCharMap[e].hideMenu()},r.getActiveMenuScope=function(){for(var e in r.triggerCharMap)if(r.triggerCharMap.hasOwnProperty(e)&&r.triggerCharMap[e].visible)return r.triggerCharMap[e];return null},r.selectActive=function(){for(var e in r.triggerCharMap)r.triggerCharMap.hasOwnProperty(e)&&r.triggerCharMap[e].visible&&r.triggerCharMap[e].selectActive()},r.isActive=function(){for(var e in r.triggerCharMap)if(r.triggerCharMap.hasOwnProperty(e)&&r.triggerCharMap[e].visible)return!0;return!1},r.isContentEditable=function(){return"INPUT"!==r.targetElement.nodeName&&"TEXTAREA"!==r.targetElement.nodeName},r.replaceMacro=function(e,t){t?s.replaceMacroText(r.context(),r.targetElement,r.targetElementPath,r.targetElementSelectedOffset,r.macros,r.macros[e]):(r.replacingMacro=!0,r.timer=i(function(){s.replaceMacroText(r.context(),r.targetElement,r.targetElementPath,r.targetElementSelectedOffset,r.macros,r.macros[e]),angular.element(r.targetElement).triggerHandler("change"),r.replacingMacro=!1},300),r.$on("$destroy",function(){i.cancel(r.timer)}))},r.addMenu=function(e){e.parentScope&&r.triggerCharMap.hasOwnProperty(e.triggerChar)||(r.triggerCharMap[e.triggerChar]=e,void 0===r.triggerCharSet&&(r.triggerCharSet=[]),r.triggerCharSet.push(e.triggerChar),e.setParent(r))},r.$on("menuCreated",function(e,t){void 0===n.id&&void 0===n.mentioId||(n.id===t.targetElement||void 0!==n.mentioId&&r.altId===t.targetElement)&&r.addMenu(t.scope)}),e.on("click",function(){r.isActive()&&r.$apply(function(){r.hideAll()})}),e.on("keydown keypress paste",function(e){var t=r.getActiveMenuScope();t&&(9!==e.which&&13!==e.which||(e.preventDefault(),t.selectActive()),27===e.which&&(e.preventDefault(),t.$apply(function(){t.hideMenu()})),40===e.which&&(e.preventDefault(),t.$apply(function(){t.activateNextItem()}),t.adjustScroll(1)),38===e.which&&(e.preventDefault(),t.$apply(function(){t.activatePreviousItem()}),t.adjustScroll(-1)),37!==e.which&&39!==e.which||e.preventDefault())})}],link:function(l,e,t){if(l.triggerCharMap={},l.targetElement=e,t.$set("autocomplete","off"),t.mentioItems){l.localItems=[],l.parentScope=l;var n=t.mentioSearch?' mentio-items="items"':' mentio-items="localItems"';l.defaultTriggerChar=t.mentioTriggerChar?l.$eval(t.mentioTriggerChar):"@";var r='<mentio-menu mentio-search="bridgeSearch(term)" mentio-select="bridgeSelect(item)"'+n;t.mentioTemplateUrl&&(r=r+' mentio-template-url="'+t.mentioTemplateUrl+'"'),r=r+" mentio-trigger-char=\"'"+l.defaultTriggerChar+'\'" mentio-parent-scope="parentScope"/>';var i=a(r)(l);e.parent().append(i),l.$on("$destroy",function(){i.remove()})}function o(e){function t(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()}var n=l.getActiveMenuScope();if(n){if(9===e.which||13===e.which)return t(e),n.selectActive(),!1;if(27===e.which)return t(e),n.$apply(function(){n.hideMenu()}),!1;if(40===e.which)return t(e),n.$apply(function(){n.activateNextItem()}),n.adjustScroll(1),!1;if(38===e.which)return t(e),n.$apply(function(){n.activatePreviousItem()}),n.adjustScroll(-1),!1;if(37===e.which||39===e.which)return t(e),!1}}t.mentioTypedTerm&&(l.syncTriggerText=!0),l.$watch("iframeElement",function(e){if(e&&e.contentWindow){var t=e.contentWindow.document;t.addEventListener("click",function(){l.isActive()&&l.$apply(function(){l.hideAll()})}),t.addEventListener("keydown",o,!0),l.$on("$destroy",function(){t.removeEventListener("keydown",o)})}}),l.$watch("ngModel",function(e){if(e&&""!==e||l.isActive())if(void 0!==l.triggerCharSet)if(l.contentEditableMenuPasted)l.contentEditableMenuPasted=!1;else{l.replacingMacro&&(u.cancel(l.timer),l.replacingMacro=!1);var t=l.isActive(),n=l.isContentEditable(),r=s.getTriggerInfo(l.context(),l.triggerCharSet,l.requireLeadingSpace,t);if(void 0!==r&&(!t||t&&(n&&r.mentionTriggerChar===l.currentMentionTriggerChar||!n&&r.mentionPosition===l.currentMentionPosition)))r.mentionSelectedElement&&(l.targetElement=r.mentionSelectedElement,l.targetElementPath=r.mentionSelectedPath,l.targetElementSelectedOffset=r.mentionSelectedOffset),l.setTriggerText(r.mentionText),l.currentMentionPosition=r.mentionPosition,l.currentMentionTriggerChar=r.mentionTriggerChar,l.query(r.mentionTriggerChar,r.mentionText);else{var i=l.typedTerm;l.setTriggerText(""),l.hideAll();var o=s.getMacroMatch(l.context(),l.macros);if(void 0!==o)l.targetElement=o.macroSelectedElement,l.targetElementPath=o.macroSelectedPath,l.targetElementSelectedOffset=o.macroSelectedOffset,l.replaceMacro(o.macroText,o.macroHasTrailingSpace);else if(l.selectNotFound&&i&&""!==i){var a=l.triggerCharMap[l.currentMentionTriggerChar];if(a){var c=a.select({item:{label:i}});"function"==typeof c.then?c.then(l.replaceText):l.replaceText(c,!0)}}}}else m.error("Error, no mentio-items attribute was provided, and no separate mentio-menus were specified.  Nothing to do.")})}}}]).directive("mentioMenu",["mentioUtil","$rootScope","$log","$window","$document",function(n,e,t,r,a){return{restrict:"E",scope:{search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",triggerChar:"=mentioTriggerChar",forElem:"=mentioFor",parentScope:"=mentioParentScope"},templateUrl:function(e,t){return void 0!==t.mentioTemplateUrl?t.mentioTemplateUrl:"mentio-menu.tpl.html"},controller:["$scope",function(n){n.visible=!1,this.activate=n.activate=function(e){n.activeItem=e},this.isActive=n.isActive=function(e){return n.activeItem===e},this.selectItem=n.selectItem=function(e){var t=n.select({item:e});"function"==typeof t.then?t.then(n.parentMentio.replaceText):n.parentMentio.replaceText(t)},n.activateNextItem=function(){var e=n.items.indexOf(n.activeItem);this.activate(n.items[(e+1)%n.items.length])},n.activatePreviousItem=function(){var e=n.items.indexOf(n.activeItem);this.activate(n.items[0===e?n.items.length-1:e-1])},n.isFirstItemActive=function(){return 0===n.items.indexOf(n.activeItem)},n.isLastItemActive=function(){return n.items.indexOf(n.activeItem)===n.items.length-1},n.selectActive=function(){n.selectItem(n.activeItem)},n.isVisible=function(){return n.visible},n.showMenu=function(){n.visible||(n.requestVisiblePendingSearch=!0)},n.setParent=function(e){n.parentMentio=e,n.targetElement=e.targetElement}}],link:function(i,o){if(o[0].parentNode.removeChild(o[0]),a[0].body.appendChild(o[0]),i.menuElement=o,i.parentScope)i.parentScope.addMenu(i);else{if(!i.forElem)return void t.error("mentio-menu requires a target element in tbe mentio-for attribute");if(!i.triggerChar)return void t.error("mentio-menu requires a trigger char");e.$broadcast("menuCreated",{targetElement:i.forElem,scope:i})}angular.element(r).bind("resize",function(){if(i.isVisible()){var e=[];e.push(i.triggerChar),n.popUnderMention(i.parentMentio.context(),e,o,i.requireLeadingSpace)}}),i.$watch("items",function(e){e&&0<e.length?(i.activate(e[0]),!i.visible&&i.requestVisiblePendingSearch&&(i.visible=!0,i.requestVisiblePendingSearch=!1)):i.hideMenu()}),i.$watch("isVisible()",function(e){if(e){var t=[];t.push(i.triggerChar),n.popUnderMention(i.parentMentio.context(),t,o,i.requireLeadingSpace)}}),i.parentMentio.$on("$destroy",function(){o.remove()}),i.hideMenu=function(){i.visible=!1,o.css("display","none")},i.adjustScroll=function(e){var t=o[0],n=t.querySelector("ul"),r=t.querySelector("[mentio-menu-item].active")||t.querySelector("[data-mentio-menu-item].active");return i.isFirstItemActive()?n.scrollTop=0:i.isLastItemActive()?n.scrollTop=n.scrollHeight:void(1===e?n.scrollTop+=r.offsetHeight:n.scrollTop-=r.offsetHeight)}}}}]).directive("mentioMenuItem",function(){return{restrict:"A",scope:{item:"=mentioMenuItem"},require:"^mentioMenu",link:function(e,t,n,r){e.$watch(function(){return r.isActive(e.item)},function(e){e?t.addClass("active"):t.removeClass("active")}),t.bind("mouseenter",function(){e.$apply(function(){r.activate(e.item)})}),t.bind("click",function(){return r.selectItem(e.item),!1})}}}).filter("unsafe",["$sce",function(t){return function(e){return t.trustAsHtml(e)}}]).filter("mentioHighlight",function(){return function(e,t,n){if(t){var r=n?'<span class="'+n+'">$&</span>':"<strong>$&</strong>";return(""+e).replace(new RegExp(function(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}(t),"gi"),r)}return e}}),angular.module("mentio").factory("mentioUtil",["$window","$location","$anchorScroll","$timeout",function(l,e,t,a){function c(e,t){for(var n,r=t[0];void 0===n||0===n.height;)if(0===(n=r.getBoundingClientRect()).height&&(void 0===(r=r.childNodes[0])||!r.getBoundingClientRect))return;var i=n.top,o=i+n.height;if(i<0)l.scrollTo(0,l.pageYOffset+n.top-20);else if(o>l.innerHeight){var a=l.pageYOffset+n.top-20;100<a-l.pageYOffset&&(a=l.pageYOffset+100);var c=l.pageYOffset-(l.innerHeight-o);a<c&&(c=a),l.scrollTo(0,c)}}function h(e){var t=v(e).activeElement;if(null===t)return!1;var n=t.nodeName,r=t.getAttribute("type");return"INPUT"===n&&"text"===r||"TEXTAREA"===n}function o(e,t,n,r){var i,o=t;if(n)for(var a=0;a<n.length;a++){if(void 0===(o=o.childNodes[n[a]]))return;for(;o.length<r;)r-=o.length,o=o.nextSibling;0!==o.childNodes.length||o.length||(o=o.previousSibling)}var c=u(e);(i=v(e).createRange()).setStart(o,r),i.setEnd(o,r),i.collapse(!0);try{c.removeAllRanges()}catch(e){}c.addRange(i),t.focus()}function g(e,t,n,r){var i,o;o=u(e),(i=v(e).createRange()).setStart(o.anchorNode,n),i.setEnd(o.anchorNode,r),i.deleteContents();var a=v(e).createElement("div");a.innerHTML=t;for(var c,l,s=v(e).createDocumentFragment();c=a.firstChild;)l=s.appendChild(c);i.insertNode(s),l&&((i=i.cloneRange()).setStartAfter(l),i.collapse(!0),o.removeAllRanges(),o.addRange(i))}function f(e,t,n,r){var i=t.nodeName;"INPUT"===i||"TEXTAREA"===i?t!==v(e).activeElement&&t.focus():o(e,t,n,r)}function s(e,t){if(null===t.parentNode)return 0;for(var n=0;n<t.parentNode.childNodes.length;n++){if(t.parentNode.childNodes[n]===t)return n}}function m(e,t){var i,o,a=[];if(h(e))i=v(e).activeElement;else{var n=p(e);n&&(i=n.selected,a=n.path,o=n.offset)}var c=T(e);if(null!=c){var l,s=!1;if(0<c.length&&(" "===c.charAt(c.length-1)||" "===c.charAt(c.length-1))&&(s=!0,c=c.substring(0,c.length-1)),angular.forEach(t,function(e,t){var n=c.toUpperCase().lastIndexOf(t.toUpperCase());if(0<=n&&t.length+n===c.length){var r=n-1;0!==n&&" "!==c.charAt(r)&&" "!==c.charAt(r)||(l={macroPosition:n,macroText:t,macroSelectedElement:i,macroSelectedPath:a,macroSelectedOffset:o,macroHasTrailingSpace:s})}}),l)return l}}function p(e){var t=u(e),n=t.anchorNode,r=[];if(null!=n){for(var i,o=n.contentEditable;null!==n&&"true"!==o;)i=s(0,n),r.push(i),null!==(n=n.parentNode)&&(o=n.contentEditable);return r.reverse(),{selected:n,path:r,offset:t.getRangeAt(0).startOffset}}}function d(e,t,n,r,i){var o,a,c;if(h(e))o=v(e).activeElement;else{var l=p(e);l&&(o=l.selected,a=l.path,c=l.offset)}var s=T(e);if(null!=s){var m,u=-1;if(t.forEach(function(e){var t=s.lastIndexOf(e);u<t&&(u=t,m=e)}),0<=u&&(0===u||!n||/[\xA0\s]/g.test(s.substring(u-1,u)))){var g=s.substring(u+1,s.length);m=s.substring(u,u+1);var f=g.substring(0,1),d=0<g.length&&(" "===f||" "===f);if(i&&(g=g.trim()),!d&&(r||!/[\xA0\s]/g.test(g)))return{mentionPosition:u,mentionText:g,mentionSelectedElement:o,mentionSelectedPath:a,mentionSelectedOffset:c,mentionTriggerChar:m}}}}function u(e){return e?e.iframe.contentWindow.getSelection():window.getSelection()}function v(e){return e?e.iframe.contentWindow.document:document}function T(e){var t;if(h(e)){var n=v(e).activeElement,r=n.selectionStart;t=n.value.substring(0,r)}else{var i=u(e).anchorNode;if(null!=i){var o=i.textContent,a=u(e).getRangeAt(0).startOffset;0<=a&&(t=o.substring(0,a))}}return t}function S(e,t){var n,r,i="sel_"+(new Date).getTime()+"_"+Math.random().toString().substr(2),o=u(e),a=o.getRangeAt(0);(r=v(e).createRange()).setStart(o.anchorNode,t),r.setEnd(o.anchorNode,t),r.collapse(!1),(n=v(e).createElement("span")).id=i,n.appendChild(v(e).createTextNode("\ufeff")),r.insertNode(n),o.removeAllRanges(),o.addRange(a);var c={left:0,top:n.offsetHeight};return E(e,n,c),n.parentNode.removeChild(n),c}function E(e,t,n){for(var r=t,i=e?e.iframe:null;r;)n.left+=r.offsetLeft+r.clientLeft,n.top+=r.offsetTop+r.clientTop,!(r=r.offsetParent)&&i&&(r=i,i=null);for(r=t,i=e?e.iframe:null;r!==v().body;)r.scrollTop&&0<r.scrollTop&&(n.top-=r.scrollTop),r.scrollLeft&&0<r.scrollLeft&&(n.left-=r.scrollLeft),!(r=r.parentNode)&&i&&(r=i,i=null)}function b(e,t,n){var r=null!==window.mozInnerScreenX,i=v(e).createElement("div");i.id="input-textarea-caret-position-mirror-div",v(e).body.appendChild(i);var o=i.style,a=window.getComputedStyle?getComputedStyle(t):t.currentStyle;o.whiteSpace="pre-wrap","INPUT"!==t.nodeName&&(o.wordWrap="break-word"),o.position="absolute",o.visibility="hidden",["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"].forEach(function(e){o[e]=a[e]}),r?(o.width=parseInt(a.width)-2+"px",t.scrollHeight>parseInt(a.height)&&(o.overflowY="scroll")):o.overflow="hidden",i.textContent=t.value.substring(0,n),"INPUT"===t.nodeName&&(i.textContent=i.textContent.replace(/\s/g," "));var c=v(e).createElement("span");c.textContent=t.value.substring(n)||".",i.appendChild(c);var l={top:c.offsetTop+parseInt(a.borderTopWidth)+parseInt(a.fontSize),left:c.offsetLeft+parseInt(a.borderLeftWidth)};return E(e,t,l),v(e).body.removeChild(i),l}return{popUnderMention:function(e,t,n,r){var i,o=d(e,t,r,!1);void 0!==o?(i=h(e)?b(e,v(e).activeElement,o.mentionPosition):S(e,o.mentionPosition),n.css({top:i.top+"px",left:i.left+"px",position:"absolute",zIndex:1e4,display:"block"}),a(function(){c(e,n)},0)):n.css({display:"none"})},replaceMacroText:function(e,t,n,r,i,o){f(e,t,n,r);var a=m(e,i);if(a.macroHasTrailingSpace&&(a.macroText=a.macroText+" ",o+=" "),void 0!==a){var c=v(e).activeElement;if(h(e)){var l=a.macroPosition,s=a.macroPosition+a.macroText.length;c.value=c.value.substring(0,l)+o+c.value.substring(s,c.value.length),c.selectionStart=l+o.length,c.selectionEnd=l+o.length}else g(e,o,a.macroPosition,a.macroPosition+a.macroText.length)}},replaceTriggerText:function(e,t,n,r,i,o,a,c){f(e,t,n,r);var l=d(e,i,a,!0,c);if(void 0!==l)if(h()){var s=v(e).activeElement;o+=" ";var m=l.mentionPosition,u=l.mentionPosition+l.mentionText.length+1;s.value=s.value.substring(0,m)+o+s.value.substring(u,s.value.length),s.selectionStart=m+o.length,s.selectionEnd=m+o.length}else g(e,o+=" ",l.mentionPosition,l.mentionPosition+l.mentionText.length+1)},getMacroMatch:m,getTriggerInfo:d,selectElement:o,getTextAreaOrInputUnderlinePosition:b,getTextPrecedingCurrentSelection:T,getContentEditableSelectedPath:p,getNodePositionInParent:s,getContentEditableCaretPosition:S,pasteHtml:g,resetSelection:f,scrollIntoView:c}}]),angular.module("mentio").run(["$templateCache",function(e){e.put("/mentio-menu.tpl.html",'<style>\n.scrollable-menu {\n    height: auto;\n    max-height: 300px;\n    overflow: auto;\n}\n\n.menu-highlighted {\n    font-weight: bold;\n}\n</style>\n<ul class="dropdown-menu scrollable-menu" style="display:block">\n    <li mentio-menu-item="item" ng-repeat="item in items track by $index">\n        <a class="text-primary" ng-bind-html="item.label | mentioHighlight:typedTerm:\'menu-highlighted\' | unsafe"></a>\n    </li>\n</ul>')}]);